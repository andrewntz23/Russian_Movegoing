xquery version "3.0";
let $thisFileContent := 
<textFile>{
let $interviews := collection('/db/course/rmtp/data')
let $index := doc('/db/course/rmtp/index.xml')//@xml:id
let $distinctPersons := distinct-values($interviews//person/@ref)
for $person in $distinctPersons
let $match := $index[.=$person]/parent::person/surname
let $otherPersons := $distinctPersons[. != $person]
for $otherPerson in $otherPersons
let $otherMatch := $index[.=$otherPerson]/parent::person/surname
let $countInterviews := count($interviews//body[.//person/@ref = $person][.//person/@ref = $otherPerson])
for $interview in $interviews[.//person/@ref = $person][.//person/@ref = $otherPerson]
let $cooccurInterview := $interview/tokenize(base-uri(), '/')[last()]
return 
    concat($match, ',', $otherMatch, ',', $cooccurInterview, ',', $countInterviews), '&#10;'}</textFile>
let $fileName := "personNetwork.csv"
let $doc-db-uri := xmldb:store("/db/course/rmtp/Output" , $fileName, $thisFileContent)
return $doc-db-uri
(: W.o. <textFile> tags we receive a cardinality error in line 17 with 2300 separate $thisFileContent :)